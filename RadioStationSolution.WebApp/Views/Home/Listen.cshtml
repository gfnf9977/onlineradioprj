@model OnlineRadioStation.Domain.RadioStationEntity
@using System.Collections.Generic
@using Microsoft.AspNetCore.Http
@inject OnlineRadioStation.Services.IUserService _userService
@{
    ViewData["Title"] = $"Ефір: {Model.StationName}";
    var playlistForJs = new List<object>();
    bool isOffline = ViewBag.IsOffline ?? true;
    var userRatings = ViewBag.UserRatings as Dictionary<Guid, int> ?? new Dictionary<Guid, int>();

    if (!isOffline)
    {
        var tracksList = ViewBag.OrderedPlaylist as List<OnlineRadioStation.Domain.Track>;

        if (tracksList != null)
        {
            OnlineRadioStation.Domain.IPlaylistIterator iterator =
                new OnlineRadioStation.Domain.PlaybackQueueIterator(tracksList);

            iterator.First();
            int position = 1;

            while (!iterator.IsDone())
            {
                var track = iterator.Current();

                if (!string.IsNullOrEmpty(track.HlsUrl))
                {
                    int rating = userRatings.ContainsKey(track.TrackId) ? userRatings[track.TrackId] : 0;
                    var votes = _userService.GetTrackVotesAsync(track.TrackId).Result;
                    playlistForJs.Add(new {
                        trackId = track.TrackId.ToString(),
                        title = track.Title,
                        url = track.HlsUrl,
                        id = position,
                        userRating = rating,
                        likesCount = votes.Likes,
                        dislikesCount = votes.Dislikes
                    });
                    position++;
                }

                iterator.Next();
            }
        }
    }
}

<div class="container mt-5 text-center">
    <h1 class="display-4 fw-bold">@Model.StationName</h1>
    <p class="lead text-muted">@Model.Description</p>
    <hr class="my-4 w-50 mx-auto" />
    <div id="offlineView" class="py-5" style="@(isOffline ? "" : "display:none;")">
        <i class="bi bi-mic-mute-fill text-secondary" style="font-size: 5rem;"></i>
        <h2 class="mt-3 text-secondary">Ефір завершено</h2>
        <p>Діджей завершив трансляцію.</p>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary mt-3">На головну</a>
    </div>
    <div id="onlineView" style="@(isOffline ? "display:none;" : "")">
        <div id="playOverlay" class="py-5" style="display:none;">
            <div class="mb-4">
                <div class="spinner-grow text-danger" role="status" style="width: 1rem; height: 1rem;"></div>
                <span class="text-danger fw-bold ms-2">LIVE</span>
            </div>
            <button id="btnStartRadio" class="btn btn-danger btn-lg rounded-circle shadow-lg" style="width: 80px; height: 80px;">
                <i class="bi bi-play-fill fs-1"></i>
            </button>
            <p class="mt-3 text-muted">Натисніть, щоб підключитися</p>
        </div>
        <div id="playerContainer" style="display:none;" class="py-4">
            <div class="card shadow-sm mx-auto border-0 bg-light" style="max-width: 500px;">
                <div class="card-body text-center">
                    <h3 id="currentTrackName" class="fw-bold text-dark mb-3">Завантаження...</h3>
                    <div class="d-flex justify-content-center align-items-center gap-4 mb-4">
                        <button id="btnDislike" class="btn btn-outline-secondary rounded-circle p-3 d-flex flex-column align-items-center justify-content-center" style="width: 70px; height: 70px;" onclick="rateTrack(false)">
                            <i id="iconDislike" class="bi bi-hand-thumbs-down fs-4"></i>
                            <span id="countDislike" class="small fw-bold" style="font-size: 0.7rem;"></span>
                        </button>
                        <button id="btnLike" class="btn btn-outline-secondary rounded-circle p-3 d-flex flex-column align-items-center justify-content-center" style="width: 70px; height: 70px;" onclick="rateTrack(true)">
                            <i id="iconLike" class="bi bi-hand-thumbs-up fs-4"></i>
                            <span id="countLike" class="small fw-bold" style="font-size: 0.7rem;"></span>
                        </button>
                    </div>
                    <p class="text-muted small mb-0">Ви слухаєте прямий ефір</p>
                    <div class="mt-3">
                        <button onclick="toggleMute()" class="btn btn-sm btn-link text-secondary text-decoration-none">
                            <i id="muteIcon" class="bi bi-volume-up-fill fs-5"></i>
                        </button>
                        <audio id="audioPlayer" style="width: 0; height: 0;"></audio>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="csrf-form" style="display:none;">@Html.AntiForgeryToken()</form>

@section Scripts {
@if (!isOffline)
{
    <script>
        var playlist = @Html.Raw(Json.Serialize(playlistForJs));
        var startTrackId = @Html.Raw(Json.Serialize(ViewBag.StartTrackId));
        var startOffset = @Html.Raw(Json.Serialize(ViewBag.StartOffset ?? 0));
        var stationId = '@Model.StationId';
        var audio = document.getElementById('audioPlayer');
        var btnStart = document.getElementById('btnStartRadio');
        var overlay = document.getElementById('playOverlay');
        var container = document.getElementById('playerContainer');
        var offlineView = document.getElementById('offlineView');
        var onlineView = document.getElementById('onlineView');
        var trackLabel = document.getElementById('currentTrackName');
        var btnLike = document.getElementById('btnLike');
        var currentIndex = 0;
        var hls = null;

        async function checkStatusAndNext() {
            try {
                let response = await fetch('/Home/GetRadioStatus?stationId=' + stationId);
                if (response.ok) {
                    let status = await response.json();
                    if (status.isOffline) {
                        goOffline();
                        return;
                    }
                    playlist = status.playlist;
                    currentIndex++;
                    if (currentIndex >= playlist.length) currentIndex = 0;
                    playTrack(currentIndex, 0);
                }
            } catch (e) {
                console.error("Помилка перевірки статусу:", e);
            }
        }

        function goOffline() {
            audio.pause();
            onlineView.style.display = 'none';
            offlineView.style.display = 'block';
        }

        function playTrack(index, startTime = 0) {
            if (!playlist || playlist.length === 0) {
                goOffline();
                return;
            }
            currentIndex = index;
            var track = playlist[index];
            trackLabel.innerText = track.title;
            updateButtons(track.userRating, track.likesCount, track.dislikesCount);
            btnLike.dataset.trackId = track.trackId;
            var streamUrl = track.url;
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(streamUrl);
                hls.attachMedia(audio);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    if (startTime > 0) audio.currentTime = startTime;
                    attemptPlay();
                });
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = streamUrl;
                if (startTime > 0) audio.currentTime = startTime;
                attemptPlay();
            }
        }

        function attemptPlay() {
            var promise = audio.play();
            if (promise !== undefined) {
                promise.then(_ => {
                    overlay.style.display = 'none';
                    container.style.display = 'block';
                }).catch(error => {
                    console.log("Autoplay prevented. Show button.");
                    container.style.display = 'none';
                    overlay.style.display = 'block';
                });
            }
        }

        if (document.getElementById('onlineView').style.display !== 'none') {
            var startIndex = 0;
            if (startTrackId) {
                var foundIndex = playlist.findIndex(t => t.trackId === startTrackId);
                if (foundIndex !== -1) startIndex = foundIndex;
            }
            playTrack(startIndex, startOffset);
        }

        btnStart.addEventListener('click', function() {
            overlay.style.display = 'none';
            container.style.display = 'block';
            audio.play();
        });

        audio.addEventListener('ended', function () {
            console.log("Трек закінчився. Перевіряю ефір...");
            checkStatusAndNext();
        });

        window.toggleMute = function() {
            audio.muted = !audio.muted;
            var icon = document.getElementById('muteIcon');
            icon.className = audio.muted ? "bi bi-volume-mute-fill fs-5" : "bi bi-volume-up-fill fs-5";
        };

        window.rateTrack = async function(isLike) {
            var trackId = document.getElementById('btnLike').dataset.trackId;
            var token = document.querySelector('#csrf-form input').value;
            try {
                let response = await fetch(`/Home/RateTrack?trackId=${trackId}&isLike=${isLike}`, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': token }
                });
                if (response.status === 401) { alert("Увійдіть, щоб голосувати!"); return; }
                if (response.ok) {
                    let data = await response.json();
                    updateButtons(data.status, data.likes, data.dislikes);
                    playlist[currentIndex].userRating = data.status;
                    playlist[currentIndex].likesCount = data.likes;
                    playlist[currentIndex].dislikesCount = data.dislikes;
                }
            } catch (e) { console.error(e); }
        };

        function updateButtons(status, likes, dislikes) {
            var btnLike = document.getElementById('btnLike');
            var btnDislike = document.getElementById('btnDislike');
            var iconLike = document.getElementById('iconLike');
            var iconDislike = document.getElementById('iconDislike');
            var countLike = document.getElementById('countLike');
            var countDislike = document.getElementById('countDislike');
            btnLike.className = "btn btn-outline-secondary rounded-circle p-3 d-flex flex-column align-items-center justify-content-center";
            btnDislike.className = "btn btn-outline-secondary rounded-circle p-3 d-flex flex-column align-items-center justify-content-center";
            iconLike.className = "bi bi-hand-thumbs-up fs-4";
            iconDislike.className = "bi bi-hand-thumbs-down fs-4";
            if (status === 1) {
                btnLike.classList.remove('btn-outline-secondary');
                btnLike.classList.add('btn-success');
                iconLike.className = "bi bi-hand-thumbs-up-fill fs-4";
            } else if (status === -1) {
                btnDislike.classList.remove('btn-outline-secondary');
                btnDislike.classList.add('btn-danger');
                iconDislike.className = "bi bi-hand-thumbs-down-fill fs-4";
            }
            countLike.innerText = (likes > 0) ? likes : "";
            countDislike.innerText = (dislikes > 0) ? dislikes : "";
        }
    </script>
}
}
