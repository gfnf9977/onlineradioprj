@model OnlineRadioStation.Domain.RadioStationEntity
@using System.Collections.Generic
@{
    ViewData["Title"] = $"–°–ª—É—Ö–∞—Ç–∏: {Model.StationName}";
    var iterator = Model.CreateIterator();
    iterator.First();
    var playlistForJs = new List<object>();
}
<h1 class="display-5 fw-bold text-center mb-4">–ó–∞—Ä–∞–∑ –≥—Ä–∞—î: @Model.StationName</h1>
<p class="text-center text-muted mb-5">@Model.Description</p>
<div id="playOverlay" class="text-center my-5">
    <button id="btnStartRadio" class="btn btn-lg btn-success rounded-pill px-5 py-4 shadow-lg fs-3">
        <i class="bi bi-broadcast"></i> –£–≤—ñ–º–∫–Ω—É—Ç–∏ –†–∞–¥—ñ–æ ROKS
    </button>
    <p class="mt-3 text-muted">–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –∂–∏–≤–æ–≥–æ –µ—Ñ—ñ—Ä—É</p>
</div>
<div id="playerContainer" style="display:none;" class="text-center">
    <video id="audioPlayer" controls preload="none" style="width: 100%; max-width: 650px; background:#000; border-radius:12px;" class="shadow"></video>
    <div class="mt-3">
        <strong>–ì—Ä–∞—î –∑–∞—Ä–∞–∑:</strong>
        <span id="currentTrackName" class="text-success fs-5 fw-bold">–≥–æ—Ç—É—î–º–æ –µ—Ñ—ñ—Ä...</span>
    </div>
</div>
<hr class="my-5" />
@if (iterator.IsDone())
{
    <div class="alert alert-warning text-center">
        –ü–ª–µ–π–ª–∏—Å—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π. –î—ñ–¥–∂–µ–π —â–µ –Ω–µ –≤–≤—ñ–º–∫–Ω—É–≤ –µ—Ñ—ñ—Ä
    </div>
}
else
{
    <h3 class="mb-4">–ü–ª–µ–π–ª–∏—Å—Ç —Å—Ç–∞–Ω—Ü—ñ—ó</h3>
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>–ù–∞–∑–≤–∞ —Ç—Ä–µ–∫—É</th>
                <th>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            @{ int position = 1; }
            @while (!iterator.IsDone())
            {
                var track = iterator.Current();
                if (!string.IsNullOrEmpty(track.HlsUrl))
                {
                    playlistForJs.Add(new
                    {
                        trackId = track.TrackId.ToString(),
                        title = track.Title,
                        url = track.HlsUrl,
                        id = position
                    });
                }
                <tr id="row-@position">
                    <td>@(position++)</td>
                    <td>@track.Title</td>
                    <td>@track.Duration.ToString(@"mm\:ss")</td>
                    <td class="status-cell text-muted">–≤ —á–µ—Ä–∑—ñ</td>
                </tr>
                iterator.Next();
            }
        </tbody>
    </table>
}

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var playlist = @Html.Raw(Json.Serialize(playlistForJs));
        var startTrackId = @Html.Raw(Json.Serialize(ViewBag.StartTrackId));
        var startOffset = @Html.Raw(Json.Serialize(ViewBag.StartOffset ?? 0));
        var audio = document.getElementById('audioPlayer');
        var btnStart = document.getElementById('btnStartRadio');
        var overlay = document.getElementById('playOverlay');
        var container = document.getElementById('playerContainer');
        var trackLabel = document.getElementById('currentTrackName');
        var currentIndex = 0;
        var hls = null;

        function updateTableUI(rowId) {
            document.querySelectorAll('tr').forEach(row => {
                row.classList.remove('table-active');
                var cell = row.querySelector('.status-cell');
                if(cell) {
                    cell.innerText = "–í —á–µ—Ä–∑—ñ";
                    cell.className = "status-cell text-muted";
                }
            });
            var activeRow = document.getElementById('row-' + rowId);
            if (activeRow) {
                activeRow.classList.add('table-active');
                var cell = activeRow.querySelector('.status-cell');
                if(cell) {
                    cell.innerText = "üîä –ì—Ä–∞—î";
                    cell.className = "status-cell text-primary fw-bold";
                }
            }
        }

        function loadTrack(index, seekTo = 0) {
            if (index >= playlist.length) return;
            currentIndex = index;
            var track = playlist[index];
            trackLabel.innerText = track.title;
            updateTableUI(track.id);
            var streamUrl = track.url;
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(streamUrl);
                hls.attachMedia(audio);
                if (seekTo > 0) {
                    hls.on(Hls.Events.MANIFEST_PARSED, function () {
                        audio.currentTime = seekTo;
                    });
                }
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = streamUrl;
                if (seekTo > 0) {
                    audio.currentTime = seekTo;
                }
            }
        }

        function playRadio() {
            overlay.style.display = 'none';
            container.style.display = 'block';
            audio.play().catch(e => console.error("Playback failed:", e));
        }

        var startIndex = 0;
        if (startTrackId) {
            var foundIndex = playlist.findIndex(t => t.trackId === startTrackId);
            if (foundIndex !== -1) {
                startIndex = foundIndex;
            }
        }

        if (playlist.length > 0) {
            loadTrack(startIndex, startOffset);
        }

        btnStart.addEventListener('click', playRadio);

        // –ê–≤—Ç–æ-–ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è (–ó–∞—Ü–∏–∫–ª–µ–Ω–µ)
        audio.addEventListener('ended', function () {
            currentIndex++;

            // –Ø–∫—â–æ –¥—ñ–π—à–ª–∏ –¥–æ –∫—ñ–Ω—Ü—è —Å–ø–∏—Å–∫—É -> –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ (0)
            if (currentIndex >= playlist.length) {
                console.log("–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è. –ü–æ—á–∏–Ω–∞—î–º–æ —Å–ø–æ—á–∞—Ç–∫—É (Loop).");
                currentIndex = 0;
            }

            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π (–∞–±–æ –ø–µ—Ä—à–∏–π) —Ç—Ä–µ–∫
            loadTrack(currentIndex, 0);
            audio.play();
        });
    });
</script>
}