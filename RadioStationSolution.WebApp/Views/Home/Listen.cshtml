@model OnlineRadioStation.Domain.RadioStationEntity
@using System.Collections.Generic

@{
    ViewData["Title"] = $"–°–ª—É—Ö–∞—Ç–∏: {Model.StationName}";
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ —ñ—Ç–µ—Ä–∞—Ç–æ—Ä
    var iterator = Model.CreateIterator();
    iterator.First();

    // –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–ª—è JavaScript, –∫—É–¥–∏ –ø–æ–∫–ª–∞–¥–µ–º–æ –≤—Å—ñ URL
    var playlistForJs = new List<object>();
}

<h1>–ó–∞—Ä–∞–∑ –≥—Ä–∞—î: @Model.StationName</h1>
<p>@Model.Description</p>

<video id="audioPlayer" controls autoplay style="width: 100%; max-width: 600px; background: #000; border-radius: 5px;"></video>
<div class="mt-2">
    <strong>–ì—Ä–∞—î –∑–∞—Ä–∞–∑: </strong> <span id="currentTrackName" class="text-primary">...</span>
</div>
<hr />

@if (iterator.IsDone())
{
    <div class="alert alert-info">
        –ü–ª–µ–π–ª–∏—Å—Ç —Ü—ñ—î—ó —Å—Ç–∞–Ω—Ü—ñ—ó –Ω–∞—Ä–∞–∑—ñ –ø–æ—Ä–æ–∂–Ω—ñ–π.
    </div>
}
else
{
    <h3>–ü–ª–µ–π–ª–∏—Å—Ç —Å—Ç–∞–Ω—Ü—ñ—ó:</h3>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>#</th>
                <th>–ù–∞–∑–≤–∞ —Ç—Ä–µ–∫—É</th>
                <th>–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            @{ int position = 1; }
            @while (!iterator.IsDone())
            {
                var track = iterator.Current();
                
                // –î–æ–¥–∞—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ —Ç—Ä–µ–∫ —É —Å–ø–∏—Å–æ–∫ –¥–ª—è JS
                // –í–∞–∂–ª–∏–≤–æ: –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ HlsUrl –Ω–∞ null
                if (!string.IsNullOrEmpty(track.HlsUrl))
                {
                    playlistForJs.Add(new { 
                        title = track.Title, 
                        url = track.HlsUrl,
                        id = position // ID —Ä—è–¥–∫–∞ —Ç–∞–±–ª–∏—Ü—ñ –¥–ª—è –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏
                    });
                }

                <tr id="row-@position">
                    <td>@(position++)</td>
                    <td>@track.Title</td>
                    <td>@track.Duration.ToString(@"mm\:ss")</td>
                    <td class="status-cell text-muted">–í —á–µ—Ä–∑—ñ</td>
                </tr>
                iterator.Next();
            }
        </tbody>
    </table>
}

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // 1. –û—Ç—Ä–∏–º—É—î–º–æ –í–ï–°–¨ –ø–ª–µ–π–ª–∏—Å—Ç –∑ C# —É –≤–∏–≥–ª—è–¥—ñ JSON-–º–∞—Å–∏–≤—É
        var playlist = @Html.Raw(Json.Serialize(playlistForJs));
        
        var audio = document.getElementById('audioPlayer');
        var trackLabel = document.getElementById('currentTrackName');
        var currentIndex = 0;
        var hls = null;

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç—Ä–µ–∫—É –∑–∞ —ñ–Ω–¥–µ–∫—Å–æ–º
        function loadTrack(index) {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∫—ñ–Ω–µ—Ü—å –ø–ª–µ–π–ª–∏—Å—Ç–∞
            if (index >= playlist.length) {
                console.log("–ü–ª–µ–π–ª–∏—Å—Ç –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è.");
                trackLabel.innerText = "–ï—Ñ—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ";
                return;
            }

            currentIndex = index;
            var track = playlist[index];
            var streamUrl = track.url;

            // –û–Ω–æ–≤–ª—é—î–º–æ UI (–Ω–∞–∑–≤—É —Ç–∞ —Ç–∞–±–ª–∏—Ü—é)
            trackLabel.innerText = track.title;
            updateTableUI(track.id);

            // –õ–æ–≥—ñ–∫–∞ HLS.js –∞–±–æ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy(); // –ó–Ω–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –µ–∫–∑–µ–º–ø–ª—è—Ä HLS, —â–æ–± –Ω–µ –±—É–ª–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
                }
                hls = new Hls();
                hls.loadSource(streamUrl);
                hls.attachMedia(audio);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    audio.play().catch(e => console.log("Autoplay blocked:", e));
                });
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = streamUrl;
                audio.addEventListener('loadedmetadata', function () {
                    audio.play();
                });
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç—Ä–µ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—ñ
        function updateTableUI(rowId) {
            // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ —É –≤—Å—ñ—Ö —Ä—è–¥–∫—ñ–≤
            document.querySelectorAll('tr').forEach(row => {
                row.classList.remove('table-active');
                var cell = row.querySelector('.status-cell');
                if(cell) cell.innerText = "";
            });

            // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π
            var activeRow = document.getElementById('row-' + rowId);
            if (activeRow) {
                activeRow.classList.add('table-active');
                var cell = activeRow.querySelector('.status-cell');
                if(cell) {
                    cell.innerText = "üîä –ì—Ä–∞—î";
                    cell.classList.remove('text-muted');
                    cell.classList.add('text-primary', 'fw-bold');
                }
            }
        }

        // === –ì–û–õ–û–í–ù–ê –§–Ü–®–ö–ê: –°–ª—É—Ö–∞—î–º–æ –ø–æ–¥—ñ—é "ended" ===
        audio.addEventListener('ended', function () {
            console.log("–¢—Ä–µ–∫ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è. –í–º–∏–∫–∞—é –Ω–∞—Å—Ç—É–ø–Ω–∏–π...");
            loadTrack(currentIndex + 1);
        });

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä—à–∏–π —Ç—Ä–µ–∫ (—è–∫—â–æ –ø–ª–µ–π–ª–∏—Å—Ç –Ω–µ –ø–æ—Ä–æ–∂–Ω—ñ–π)
        if (playlist.length > 0) {
            loadTrack(0);
        } else {
            trackLabel.innerText = "–ù–µ–º–∞—î —Ç—Ä–µ–∫—ñ–≤";
            audio.style.display = 'none';
        }
    });
</script>
}